<html>
  <head>
    <title>Vote under MPC</title>
    <style>
      .error {
        color: #FF0000;
      }
    </style>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/lib/sodium.js"></script>
    <script src="/lib/jiff-client.js"></script>
    <script type="text/javascript">
      var jiff_instance;

      function connect() {
        $('#connectButton').prop('disabled', true);
        var computation_id = $('#computation_id').val();
        var party_count = parseInt($('#count').val());

        if(isNaN(party_count)) {
          $("#output").append("<p class='error'>Party count must be a valid number!</p>");
          $('#connectButton').prop('disabled', false);
        } else {
          var options = { party_count: party_count};
          options.onError = function(error) { $("#output").append("<p class='error'>"+error+"</p>"); };
          options.onConnect = function() { $("#output").append("<p>All parties Connected!</p>"); $("#voteButton").attr("disabled", false); };

          var hostname = window.location.hostname.trim();
          var port = window.location.port;
          if(port == null || port == '') 
            port = "80";
          if(!(hostname.startsWith("http://") || hostname.startsWith("https://")))
            hostname = "http://" + hostname;
          if(hostname.endsWith("/"))
            hostname = hostname.substring(0, hostname.length-1);
          if(hostname.indexOf(":") > -1)
            hostanme = hostname.substring(0, hostname.indexOf(":"));
  
          hostname = hostname + ":" + port;
          jiff_instance = jiff.make_jiff(hostname, computation_id, options);
        }
      }

      function vote() {
        var inputs = [];
        var radios = $("input[type=radio]");
        var oneChecked = false;
        for(var i = 0; i < radios.length; i++) {
          inputs.push( radios[i].checked ? 1 : 0 );
          oneChecked = oneChecked || radios[i].checked;
        }

        if(!oneChecked) {
          $("#output").append("<p class='error'>Please vote for a beer!</p>");
        } else {
          MPC(inputs);
        }
      }

      function MPC(inputs) {
        $("#sumButton").attr("disabled", true);
        $("#output").append("<p>Starting...</p>");

        //This array holds the shares for each option in the voting
        var option_shares = [];

        for(var i = 0; i < inputs.length; i++)
          //save shares across parties for each option 
          option_shares.push(jiff_instance.share(inputs[i]));

        //Get a patial tally for each option in the vote by adding the shares across parties together.
        for(var i = 0; i < option_shares.length; i++) {
          var sum = option_shares[i][1];
          for(var j = 2; j <= jiff_instance.party_count; j++)
            sum = sum.sadd(option_shares[i][j]);
          option_shares[i] = sum;
        }

        //Now finally redistribute the partial tallys to compute a total tally across each client.
        jiff_instance.open_all(option_shares, [1]).then(handleResult, handleError);
      }

      function handleResult(results) {
        for(var i = 0; i < results.length; i++) {
          if(results[i] == null) continue;
          $("#res"+i).html(results[i]);
        }

        $("#sumButton").attr("disabled", false);
      }

      function handleError() {
        console.log("Error in open_all");
      }
    </script>

  <link rel="stylesheet" type="text/css" href="./style.css">
  <link href="https://fonts.googleapis.com/css?family=Timmana" rel="stylesheet">


  </head>
  <body>
    <h1>Connect JIFF</h1>
    <label for="computation_id">Computation ID</label><input id="computation_id" value="test-vote"></input><br/><br/>
    <label for="count">Party Count<label> <input id="count" pattern="[0-9]*"> &nbsp; <button id="connectButton" onclick="connect();">Connect</button>
    <br/><br/>
    <hr/>
    <h1>Vote for the Best Beer</h1>
    <label><input type="radio" name="beer"/><img src="https://drizly-products3.imgix.net/ci-harpoon-ipa-25ec827c10057591.jpeg?auto=format%2Ccompress&fm=jpeg&q=20" height="150" alt="harpoon IPA"></label> &nbsp; <span id="res0"></span><br/>
    <label><input type="radio" name="beer"/><img src="https://drizly-products0.imgix.net/ci-guinness-draught-39d3541fc7e182f2.png?auto=format%2Ccompress&fm=jpeg&q=20" height="150" alt="guiness"></label> &nbsp; <span id="res1"></span><br/>
    <label><input type="radio" name="beer"/><img src="https://drizly-products3.imgix.net/ci-goose-island-ipa-158e904177a3d9f0.jpeg?auto=format%2Ccompress&fm=jpeg&q=20" height="150" alt="guiness"></label> &nbsp; <span id="res2"></span><br/>
    <label><input type="radio" name="beer"/><img src="https://drizly-products2.imgix.net/ci-cisco-grey-lady-9cd77580c467893a.png?auto=format%2Ccompress&fm=jpeg&q=20" height="150" alt="guiness"></label> &nbsp; <span id="res3"></span><br/>
    <br/>
    <button onclick="vote()" id="voteButton" disabled="disabled">Vote</button>
    <div id="output"></div>
  </body>
</html>
